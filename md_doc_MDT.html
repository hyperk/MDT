<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libDataModel.so: MDT Technical Documentation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libDataModel.so
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">MDT Technical Documentation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md1"></a>
1. System Overview</h1>
<p><b>MDT</b> is a C++ library designed to post-process simulation output from <b>WCSim</b> (Water Cherenkov Simulator). Its primary function is to bridge the gap between "True Hits" (Monte Carlo photoelectrons) and "Digitized Hits" (ADC counts and timestamps representing electronic readout).</p>
<p>The system is architected around three main phases:</p><ol type="1">
<li><b>Merging</b>: Combining true hits from multiple sources (e.g., neutrino interactions + beam background) and adding intrinsic PMT noise (Dark Rate).</li>
<li><b>Digitizing</b>: Simulating the PMT and electronics response to convert photoelectrons (PE) into digital time and charge.</li>
<li><b>Triggering</b>: Applying detector trigger logic to select events of interest.</li>
</ol>
<h1><a class="anchor" id="autotoc_md2"></a>
2. Core Library Architecture (&lt;tt&gt;cpp/&lt;/tt&gt;)</h1>
<p>The core logic resides in <code>cpp/src</code> and <code>cpp/include</code>. The architecture relies heavily on polymorphism to handle different PMT types and digitization models.</p>
<h2><a class="anchor" id="autotoc_md3"></a>
2.1. PMT Response Model (&lt;tt&gt;PMTResponse&lt;/tt&gt;)</h2>
<p>The <code><a class="el" href="classPMTResponse.html">PMTResponse</a></code> class hierarchy defines how a specific PMT behaves physically (Quantum Efficiency, Transit Time Spread, Gain).</p>
<ul>
<li><b>Base Class</b>: <code><a class="el" href="classPMTResponse.html">PMTResponse</a></code> (Abstract)<ul>
<li><b>Interface</b>:<ul>
<li><code>GetRawSPE(...)</code>: Returns the charge of a Single Photoelectron (SPE), typically drawn from a distribution, for standard <code><a class="el" href="classHitDigitizer.html">HitDigitizer</a></code>.</li>
<li><code>HitTimeSmearing(Q)</code>: Returns the time jitter (resolution) based on charge <code>Q</code>, for standard <code><a class="el" href="classHitDigitizer.html">HitDigitizer</a></code>.</li>
<li><code>ApplyDE(...)</code>: Determines if a photon is detected based on angular efficiency.</li>
</ul>
</li>
</ul>
</li>
<li><b>Generic Implementation</b>: <code><a class="el" href="classGenericPMTResponse.html">GenericPMTResponse</a></code><ul>
<li>Handles loading standard configuration files:<ul>
<li><b>SPE CDF</b>: Cumulative Distribution Function for charge generation.</li>
<li><b>PMTDE</b>: mPMT_ID-dependent angular efficiency maps.</li>
<li><b>PMTTime</b>: PMT-specific timing offsets.</li>
</ul>
</li>
</ul>
</li>
<li><b>Specific Implementations</b>:<ul>
<li><code><a class="el" href="classResponseBoxandLine20inchHQE.html">ResponseBoxandLine20inchHQE</a></code>: Implements a specific time smearing model using <code>ksig_param</code> and <code>klambda_param</code>.</li>
<li><code><a class="el" href="classResponse3inchR14374__WCTE.html">Response3inchR14374_WCTE</a></code>: Uses a <code>TGraph</code> (<code>gTResol</code>) to interpolate timing resolution as a function of charge.</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md4"></a>
2.2. Digitization Logic (&lt;tt&gt;HitDigitizer&lt;/tt&gt;)</h2>
<p>The <code><a class="el" href="classHitDigitizer.html">HitDigitizer</a></code> class is responsible for converting a collection of True Hits on a single PMT into Digitized Hits.</p>
<ul>
<li><b>Base Class</b>: <code><a class="el" href="classHitDigitizer.html">HitDigitizer</a></code><ul>
<li>**Standard Algorithm (<code>DigitizeTube</code>)**:<ol type="1">
<li>Sorts true hits by time.</li>
<li>Iterates through hits using an <b>Integration Window</b> (<code>fIntegWindow</code>).</li>
<li>Sums charge of all hits within the window.</li>
<li>Applies <code>HitTimeSmearing</code> from the <code><a class="el" href="classPMTResponse.html">PMTResponse</a></code> object.</li>
<li>Applies <code>ApplyThreshold</code> to simulate DAQ efficiency/thresholds.</li>
<li>Truncates values to simulate electronics precision (<code>fPrecisionTiming</code>, <code>fPrecisionCharge</code>).</li>
</ol>
</li>
</ul>
</li>
<li><b>Waveform Digitizer</b>: <code><a class="el" href="classHitDigitizer__mPMT.html">HitDigitizer_mPMT</a></code><ul>
<li><b>Purpose</b>: Simulates the full voltage waveform for multi-PMT (mPMT) setups or advanced analysis.</li>
<li><b>Workflow</b>:<ol type="1">
<li>**<code>BuildWavetrain</code>**: Superimposes SPE pulse shapes (loaded from <code>WaveformFile</code>) onto a histogram based on true hit times. The SPE amplitude is sampled from a Gaussian distribution of width <code>fAmplitudeSigma</code>.</li>
<li>**<code>FitWavetrain</code>**: Analyzes the generated waveform to extract hits.<ul>
<li><b>Hit Finding</b>: Looks for local maxima exceeding <code>fAmplitudeThreshold</code>.</li>
<li><b>Time</b>: Uses Linear Interpolation (CFD-like) to find the zero-crossing point.</li>
<li><b>Charge</b>: Integrates samples around the peak (<code>fChargeWindowBefore</code>, <code>fChargeWindowAfter</code>).</li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md5"></a>
2.3. Noise and Afterpulsing (&lt;tt&gt;PMTNoise&lt;/tt&gt;)</h2>
<ul>
<li><b>Dark Noise</b>:<ul>
<li><code>GenerateDarkNoise</code>: Calculates the number of noise hits using a Poisson distribution based on <code>fDarkRate</code> and the time window.</li>
<li><code>AddPhotoElectrons</code>: Injects these noise hits into the <code><a class="el" href="classHitTubeCollection.html">HitTubeCollection</a></code> as if they were true photons.</li>
</ul>
</li>
<li><b>Afterpulsing</b>:<ul>
<li><code>AddAfterpulse</code>: Iterates through <em>digitized</em> hits. If a hit triggers an afterpulse (probabilistic), a new hit is generated with a time delay and charge, then added to the digitizer.</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md6"></a>
2.4. Triggering Logic</h2>
<p>The library implements a trigger simulation via the <code><a class="el" href="classTriggerAlgo.html">TriggerAlgo</a></code> class to determine if an event should be recorded, mimicking the Data Acquisition (DAQ) logic. Results are stored in <code><a class="el" href="classTriggerInfo.html">TriggerInfo</a></code>.</p>
<ul>
<li><b>Classes</b>:<ul>
<li><code><a class="el" href="classTriggerAlgo.html">TriggerAlgo</a></code>: Handles the trigger logic. Configured via <code>MDTParFile</code>.</li>
<li><code><a class="el" href="classTriggerInfo.html">TriggerInfo</a></code>: Container for trigger results (Trigger Time, Readout Window Start/End, Number of Hits, Trigger Type).</li>
</ul>
</li>
<li><b>Algorithms</b>:<ul>
<li><b>NDigits</b> (<code>TriggerType = NDigits</code>):<ol type="1">
<li>Collects and sorts all digitized hit times from the <code><a class="el" href="classHitTubeCollection.html">HitTubeCollection</a></code>.</li>
<li>Slides a time window of width <code>NDigitsWindow</code> with step <code>NDigitsStepSize</code>.</li>
<li><b>Condition</b>: Fires if hit count &gt; <code>NDigitsThreshold</code>.</li>
<li><b>Readout</b>: Saves hits within [<code>TrigTime</code> + <code>PreTriggerWindow</code>, <code>TrigTime</code> + <code>PostTriggerWindow</code>].</li>
<li><b>Overlap</b>: Adjusts the start of the readout window if it overlaps with a previous trigger to avoid duplication.</li>
<li><b>Failure</b>: If no trigger is found, a "Failure" trigger is recorded (typically with a specific failure time and window).</li>
</ol>
</li>
<li><b>NoTrig</b> (<code>TriggerType = NoTrig</code>):<ul>
<li>Forces a trigger at T=0. Useful for saving fixed windows or debugging.</li>
</ul>
</li>
</ul>
</li>
<li><b>Usage in <a class="el" href="classMDTManager.html">MDTManager</a></b>:<ul>
<li><code>DoTrigger(pmtType)</code>: Invokes <code>TriggerAlgo::DoTrigger</code>.</li>
<li><code>GetTriggerInfo(pmtType)</code>: Returns the populated <code><a class="el" href="classTriggerInfo.html">TriggerInfo</a></code> object.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md7"></a>
3. Application Layer (&lt;tt&gt;app/&lt;/tt&gt;)</h1>
<p>The <code>app/</code> directory contains executable applications that utilize the core library to process WCSim files.</p>
<h2><a class="anchor" id="autotoc_md8"></a>
3.1. Common Workflow Patterns</h2>
<p>Most applications follow this sequence:</p><ol type="1">
<li><b><a class="el" href="classConfiguration.html">Configuration</a></b>: Read parameters (Singleton <code><a class="el" href="classConfiguration.html">Configuration</a></code> class).</li>
<li><b>Initialization</b>: Instantiate <code><a class="el" href="classMDTManager.html">MDTManager</a></code> and register PMT types.</li>
<li><b>Event Loop</b>:<ul>
<li>Read <code>wcsimrootevent</code> (True Hits).</li>
<li><b>AddTrueHits</b>: Pass hits to MDT.</li>
<li><b>DoAddDark</b>: Add noise.</li>
<li><b>DoDigitize</b>: Convert to DigiHits.</li>
<li><b>DoTrigger</b>: Run trigger logic (e.g., <code>MDT-&gt;DoTrigger(pmtType)</code>).</li>
<li><b>Write</b>: Retrieve trigger info (<code>MDT-&gt;GetTriggerInfo</code>) and save DigiHits to output ROOT file.</li>
</ul>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md9"></a>
3.2. Key Applications</h2>
<ul>
<li>**<code>appGenPileUpSpill</code>**:<ul>
<li><b>Purpose</b>: Generates "spills" containing multiple neutrino interactions and beam background events (e.g., for T2K/Hyper-K).</li>
<li><b>Logic</b>:<ul>
<li>Uses <code><a class="el" href="classWCRootDataIDNuInt.html">WCRootDataIDNuInt</a></code> and <code><a class="el" href="classWCRootDataBeamBkg.html">WCRootDataBeamBkg</a></code> to manage input files.</li>
<li>Uses <code><a class="el" href="classBeamTiming.html">BeamTiming</a></code> to distribute events in time according to beam bunch structure.</li>
<li>Merges hits from all interactions into a single <code><a class="el" href="classMDTManager.html">MDTManager</a></code> instance before digitizing.</li>
</ul>
</li>
</ul>
</li>
<li>**<code>appWCTESingleEvent</code> / <code>appIWCDSingleEvent</code>**:<ul>
<li><b>Purpose</b>: Standard processing for single-event simulations (1 input event = 1 output event).</li>
<li><b>Difference</b>: <code>WCTE</code> uses specific PMT model (<code><a class="el" href="classResponse3inchR14374__WCTE.html">Response3inchR14374_WCTE</a></code>), while <code>IWCD</code> supports hybrid ID+OD configurations.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md10"></a>
4. Class Dependency &amp; Data Flow</h1>
<div class="fragment"><div class="line">graph TD</div>
<div class="line">    App[&quot;Application (e.g., appWCTESingleEvent)&quot;] --&gt; Config[Configuration]</div>
<div class="line">    App -- Read --&gt; Input[WCRootData Input]</div>
<div class="line">    App --&gt; MDT[MDTManager]</div>
<div class="line">    </div>
<div class="line">    MDT -- Register --&gt; PMTType[PMTType]</div>
<div class="line"> </div>
<div class="line">    PMTType --&gt; Tubes[HitTubeCollection]</div>
<div class="line">    PMTType --&gt; Noise[PMTNoise]</div>
<div class="line">    PMTType --&gt; PMTResponse</div>
<div class="line">    PMTType --&gt; Digi[HitDigitizer]</div>
<div class="line">    PMTType --&gt; Trig[TriggerAlgo]</div>
<div class="line">    </div>
<div class="line">    Input -- Add TrueHits --&gt; Tubes</div>
<div class="line">    Input -- Use --&gt; PMTResponse</div>
<div class="line">    </div>
<div class="line">    Noise -- Add Dark Hits --&gt; Tubes</div>
<div class="line">    </div>
<div class="line">    Digi -- Use --&gt; PMTResponse</div>
<div class="line">    Tubes -- Digitize --&gt; Digi</div>
<div class="line">    </div>
<div class="line">    Tubes -- Pass DigiHits --&gt; Trig</div>
<div class="line">    Trig -- Generate --&gt; TrigInfo[TriggerInfo]</div>
<div class="line">    TrigInfo --&gt; Output[WCRootData Output]</div>
<div class="line">    Tubes -- Write --&gt; Output</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md11"></a>
5. Developer Guide: How to Extend</h1>
<h2><a class="anchor" id="autotoc_md12"></a>
5.1. Adding a New PMT Type</h2>
<p>To add a new PMT model (e.g., a new 3-inch PMT):</p><ol type="1">
<li><b>Create Header/Source</b>: Create <code>PMTResponseNewType.h</code> and <code>.cc</code>.</li>
<li><b>Inherit</b>: Inherit from <code><a class="el" href="classGenericPMTResponse.html">GenericPMTResponse</a></code>.</li>
<li><b>Implement</b>:<ul>
<li><code>Initialize()</code>: Load specific parameters.</li>
<li><code>HitTimeSmearing(float Q)</code>: Define the timing resolution function.</li>
</ul>
</li>
<li><b>Register</b>: In your application (e.g., <code>app/application/MyApp.cc</code>), include the header and register it: ```cpp MDT-&gt;RegisterPMTType("PMTNewType", new PMTResponseNewType()); ```</li>
</ol>
<h2><a class="anchor" id="autotoc_md13"></a>
5.2. Customizing Digitization</h2>
<p>To change how waveforms are processed:</p><ol type="1">
<li><b>Modify <code><a class="el" href="classHitDigitizer__mPMT.html">HitDigitizer_mPMT</a></code></b>:<ul>
<li>Update <code>BuildWavetrain</code> if the pulse superposition logic changes.</li>
<li>Update <code>FitWavetrain</code> to implement new hit-finding algorithms (e.g., changing from CFD to a fixed threshold or template fitting).</li>
</ul>
</li>
<li><b><a class="el" href="classConfiguration.html">Configuration</a></b>: Ensure <code>DigitizerType</code> is set correctly in the parameter file, and <code>WaveformFile</code> points to the correct SPE pulse shape.</li>
</ol>
<h2><a class="anchor" id="autotoc_md14"></a>
5.3. Adding New Trigger Logic</h2>
<ol type="1">
<li>Implement logic in <code><a class="el" href="classTriggerAlgo.html">TriggerAlgo</a></code> that scans <code><a class="el" href="classHitTubeCollection.html">HitTubeCollection</a></code> for <code>DigiHits</code> meeting coincidence criteria (e.g., NDigits).</li>
<li>Ensure <code><a class="el" href="classTriggerInfo.html">TriggerInfo</a></code> is populated with the correct trigger time and readout window.</li>
</ol>
<h1><a class="anchor" id="autotoc_md15"></a>
6. Configuration Parameters</h1>
<p>The system is driven by text-based parameter files. Key parameters include:</p><ul>
<li>**<code>DigitizerType</code>**: Selects between standard (WCSim) or waveform digitizer.<ul>
<li><code>WaveformFile</code>: Path to the text file containing the waveform pulse shape (Time vs Voltage).</li>
</ul>
</li>
<li>**<code>DarkRate</code>**: PMT dark noise rate in kHz.</li>
<li>**<code>PMTDE</code>**: Path to PMT angular efficiency file.</li>
<li><b>Trigger Parameters</b>:<ul>
<li><code>TriggerType</code>: <code>NDigits</code> or <code>NoTrig</code>.</li>
<li><code>NDigitsWindow</code>: Width of the sliding window (ns).</li>
<li><code>NDigitsThreshold</code>: Minimum number of hits to fire a trigger. </li>
</ul>
</li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
